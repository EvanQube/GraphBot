const Discord = require('discord.js')
const fs = require('fs')
const path = require('path')
let commands = new Discord.Collection()
let aliases = new Discord.Collection()
let parent = module.parent.filename.split("/");
const handle = async (dir, dirname = path.resolve(parent.splice(parent.length).join("/")), callback) => {
  fs.readdir(dir, function(err, files) {
            if (err) throw err;
            files.forEach(function(file) {
                var filepath = path.join(dir, file);
                fs.stat(filepath, function(err,stats) {
                    if (stats.isDirectory()) {
                        handle(filepath, dirname, callback);
                    } else if (stats.isFile() && file.endsWith('.js')) {
                        let props = require(`${dirname}/${filepath}`);
                        console.log(`Loaded Command: ${props.help.name} ✅`);
                        commands.set(props.help.name, props);
                        if(props.help.aliases && props.help.aliases.length > 0){
                            props.help.aliases.forEach(alias => {
                                aliases.set(alias, props.help.name);
                              });
                              console.log(`Loaded Aliases: ${props.help.aliases.join(", ")} for ${props.help.name} ✅`)
                        } else {
                            console.log(`No Aliases For: ${props.help.name} ❌`)
                        }

                    }
                });
            });
        });
}




const run = async (prefix = "!", client, msg) =>{
const args  =  msg.content.substring(prefix.length).split(" "); 
if(msg.author && msg.author.bot ) return; 
if(!msg.guild) return;
if (!msg.content.startsWith(prefix)) return;
let commandName  =  args[0].toLowerCase();
let command;
if (commands.has(commandName)) {
    command = commands.get(commandName);
} else if(aliases.has(commandName)) {
  command =  commands.get(aliases.get(commandName));
}
if(command) {
  try{
    command.run(client, msg, args)
  } catch(error) { 
    console.log(error)
  }

}
}
module.exports =  {handle, run};
